@page "{id:int}"
@using AgiloxSortingHall.Models
@using AgiloxSortingHall.ViewModels
@model StulModel

@{
    // Nastavení titulku stránky podle jména aktuálního stolu
    ViewData["Title"] = Model.Table.Name;

    // Zjištění maximální kapacity mezi všemi řadami – slouží pro CSS grid layout
    var maxCapacity = Model.Rows.Max(r => r.Capacity);
    var columnCount = Model.Rows.Count;
}

<div class="container-fluid hall-page" style="--slot-count:@maxCapacity; --column-count:@columnCount;">

    <div class="row">
        <div class="col-12 d-flex justify-content-between align-items-center my-3">

            <!-- Název stolu -->
            <h1 class="mb-0 text-light">@Model.Table.Name</h1>

            <div class="d-flex align-items-center gap-2">
                <!-- /// Původní přepínač zobrazení, vypnuto kvůli omezenému počtu tabletů -->
               @*  <!-- Přepínač zobrazení – větší kvůli tabletu -->
                <div class="btn-group btn-group-lg me-2" role="group" aria-label="Přepínač zobrazení">
                    <a asp-page="./Stul"
                       asp-route-id="@Model.Table.Id"
                       asp-route-view="rows"
                       class="btn @(Model.ViewMode == "rows" ? "btn-primary" : "btn-outline-primary") px-4">
                        Řady
                    </a>
                    <a asp-page="./Stul"
                       asp-route-id="@Model.Table.Id"
                       asp-route-view="articles"
                       class="btn @(Model.ViewMode == "articles" ? "btn-primary" : "btn-outline-primary") px-4">
                        Artikly
                    </a>
                </div>
 *@
                <!-- Tlačítko zpět – také větší -->
                <a asp-page="/Index" class="btn btn-outline-secondary btn-lg">
                    Zpět
                </a>
            </div>
        </div>

        @* Pokud má stůl aktivní pending call, zobrazíme čekací obrazovku *@
        @if (Model.PendingCall != null)
        {
            var call = Model.PendingCall;
            var rowName = call.HallRow?.Name ?? "(neznámá řada)";
            var article = call.HallRow?.Article;

            <div class="hall-wait d-flex flex-column justify-content-center align-items-center text-light">
                <div class="text-center mb-4">

                    <!-- Nadpis sekce čekání -->
                    <h2 class="mb-3 fs-1">Čeká na doručení</h2>

                    <!-- Zobrazení základních informací o callu -->
                    <p class="fs-4 mb-1">
                        Řada: <strong>@rowName</strong>
                    </p>

                    @* Pokud je dostupný artikl, zobrazíme i jeho identifikaci *@
                    @if (!string.IsNullOrWhiteSpace(article))
                    {
                        <p class="fs-4">
                            Artikl: <strong>@article</strong>
                        </p>
                    }

                    @* Rozlišení dvou stavů: čekáme buď na skladníka, nebo už jede Agilox *@
                    @if (call.OrderId != null)
                    {
                        <p class="fs-5 text-secondary mt-3">
                            Čeká se na doplnění palety skladníkem…
                        </p>
                    }
                    else
                    {
                        <p class="fs-5 text-secondary mt-3">
                            Čeká se na doručení Agiloxem…
                        </p>
                        <p class="fs-6 mt-2">
                            Request ID:
                            <code class="text-info">@call.OrderId</code>
                        </p>
                    }
                </div>

                <!-- Tlačítko pro zrušení požadavku -->
                <div class="d-flex flex-column gap-3 w-100" style="max-width: 400px;">
                    <form method="post" asp-page-handler="CancelCall">
                        <button type="submit"
                                class="btn btn-outline-danger btn-lg w-100 py-3">
                            ✖ Zrušit požadavek
                        </button>
                    </form>
                </div>
            </div>
        }
        else
        {
            @* Pokud žádný pending call neexistuje, zobrazí se obsah podle zvoleného režimu *@

            @if (Model.ViewMode == "rows")
            {
                <div class="hall-columns-container">
                    @foreach (var row in Model.Rows)
                    {
                        <form method="post"
                              asp-page-handler="CallRow"
                              class="hall-column">

                            <input type="hidden" name="id" value="@Model.Table.Id" />
                            <input type="hidden" name="rowId" value="@row.Id" />

                            <button type="submit" class="btn btn-outline-primary column-button w-100 p-2">
                                @await Html.PartialAsync(
                                "_HallColumnVisual",
                                        new HallColumnVisualModel
                                        {
                                            Row = row,
                                            MaxCapacity = maxCapacity,
                                            PendingCalls = Model.PendingCalls,
                                            CurrentTableId = Model.Table.Id
                                        })
                </button>
            </form>
                        }
                </div>
            }
            else if (Model.ViewMode == "articles")
            {
                @await Html.PartialAsync("_StulArticleList", Model)
            }
        }

    </div>
</div>
