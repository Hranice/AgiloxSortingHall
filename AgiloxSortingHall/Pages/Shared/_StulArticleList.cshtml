@using AgiloxSortingHall.Enums
@using AgiloxSortingHall.Models
@using AgiloxSortingHall.ViewModels
@model AgiloxSortingHall.Pages.StulModel

@{
    // Seskupíme řady podle artiklu
    var articleGroups = Model.Rows
        .Where(r => !string.IsNullOrWhiteSpace(r.Article))
        .GroupBy(r => r.Article)
        .OrderBy(g => g.Key)
        .ToList();
}

<div class="container-fluid px-3 py-2">
    @if (!articleGroups.Any())
    {
        <p class="text-light">
            Žádné artikly nejsou k dispozici.
        </p>
    }
    else
    {
        <div class="row g-3">
            @foreach (var group in articleGroups)
            {
                // Spočítáme celkový počet fyzicky obsazených palet
                // pro daný artikl (přes všechny řady).
                var palletCount = group
                .SelectMany(r => r.Slots)
                .Count(s => s.State == PalletState.Occupied);

                <div class="col-12 col-md-6 col-lg-4 d-flex">
                    <form method="post"
                          asp-page-handler="CallArticle"
                          class="d-flex flex-fill">
                        <input type="hidden" name="id" value="@Model.Table.Id" />
                        <input type="hidden" name="article" value="@group.Key" />

                        <button type="submit"
                                class="btn flex-fill text-start p-4
                                               bg-dark text-light border border-secondary rounded-3
                                               d-flex flex-column justify-content-center shadow-sm">

                            <div class="d-flex align-items-center mb-2">
                                <i class="bi bi-box-seam fs-2 me-3 text-info"></i>
                                <span class="fs-3 fw-semibold">@group.Key</span>
                            </div>

                            <div class="mt-2 fs-5">
                                <span class="text-light">Palet fyzicky přítomno:</span>
                                <strong class="ms-1">@palletCount</strong>
                            </div>
                        </button>
                    </form>
                </div>
            }
        </div>
    }
</div>
