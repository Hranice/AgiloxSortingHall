@using AgiloxSortingHall.Models
@using AgiloxSortingHall.ViewModels
@model HallColumnVisualModel

@{
    var row = Model.Row;
    var maxCapacity = Model.MaxCapacity;

    // pending call-y pro tuto řadu (seřazené podle času požadavku)
    var rowQueue = Model.PendingCalls
        .Where(c => c.HallRowId == row.Id && c.Status == RowCallStatus.Pending)
        .OrderBy(c => c.RequestedAt)
        .ToList();

    // z pending callů vyfiltrujeme ty, které už mají spuštěný workflow na Agiloxu
    var dispatchedCalls = rowQueue
        .Where(c => c.OrderId != null)
        .OrderBy(c => c.RequestedAt)
        .ToList();

    // obsazené sloty v řadě (odspoda nahoru)
    var occupiedSlots = row.Slots
        .Where(s => s.State == PalletState.Occupied)
        .OrderBy(s => s.PositionIndex)
        .ToList();

    // slotId -> popisek stolu (STŮL X)
    var labelBySlotId = new Dictionary<int, string>();

    // sloty, které jsou "v převozu" = mají na sobě běžící order na Agiloxu
    var inTransitSlotIds = new HashSet<int>();

    // mapujeme jen tolik slotů, kolik máme jak obsazených slotů, tak dispatched callů
    var mapCount = Math.Min(occupiedSlots.Count, dispatchedCalls.Count);

    for (int i = 0; i < mapCount; i++)
    {
        var slot = occupiedSlots[i];
        var call = dispatchedCalls[i];

        var tableName = call.WorkTable?.Name ?? $"Stůl {call.WorkTableId}";

        // zvýraznění aktuálního stolu (na stránce konkrétního stolu)
        if (Model.CurrentTableId.HasValue && call.WorkTableId == Model.CurrentTableId.Value)
        {
            tableName = $"▶ {tableName}";
        }

        labelBySlotId[slot.Id] = tableName;
        inTransitSlotIds.Add(slot.Id);
    }

    // zbytek fronty = pending cally, které zatím nemají přidělenou paletu
    var remainingQueue = rowQueue.Skip(mapCount).ToList();
}

<!-- Název řady -->
<div class="header-cell text-center fw-bold mb-2">
    @row.Name
</div>

<!-- Sloty -->
@for (int pos = maxCapacity - 1; pos >= 0; pos--)
{
    var slot = row.Slots.FirstOrDefault(s => s.PositionIndex == pos);

    var cls = "slot empty";
    string? label = null;

    if (slot != null && slot.State == PalletState.Occupied)
    {
        // defaultně obsazená paleta
        cls = "slot occupied";

        // pokud je tahle paleta přiřazená běžícímu orderu, zobrazíme ji jako "in-transit"
        if (inTransitSlotIds.Contains(slot.Id))
        {
            cls = "slot in-transit";
        }

        // popisek stolu, pokud je namapovaný
        labelBySlotId.TryGetValue(slot.Id, out label);
    }

    <div class="slot-wrapper mb-1">
        <div class="@cls" style="border-color:@row.ColorHex">
            @if (!string.IsNullOrEmpty(label))
            {
                <div class="slot-label">
                    @label
                </div>
            }
        </div>
    </div>
}

<!-- Název artiklu řady -->
<div class="article-label small text-muted text-center mt-1">
    @row.Article
</div>

<!-- Zbytek fronty (ti, co čekají na paletu) -->
@if (remainingQueue.Any())
{
    <div class="queue-label small text-muted text-center mt-1">
        fronta (čekají na paletu):
        @string.Join(", ",
        remainingQueue.Select(c => c.WorkTable?.Name ?? $"Stůl {c.WorkTableId}"))
</div>
}
