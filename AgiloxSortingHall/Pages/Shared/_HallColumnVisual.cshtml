@using AgiloxSortingHall.Models
@using AgiloxSortingHall.ViewModels
@model HallColumnVisualModel

@{
    var row = Model.Row;
    var maxCapacity = Model.MaxCapacity;

    var now = DateTime.UtcNow;
    var transitDuration = TimeSpan.FromSeconds(10);

    // Všechny pending call-y pro tuto řadu (seřazené podle času)
    var rowQueue = Model.PendingCalls
        .Where(c => c.HallRowId == row.Id && c.Status == RowCallStatus.Pending)
        .OrderBy(c => c.RequestedAt)
        .ToList();

    // Obsazené sloty v této řadě (odspoda nahoru)
    var occupiedSlots = row.Slots
        .Where(s => s.State == PalletState.Occupied)
        .OrderBy(s => s.PositionIndex)
        .ToList();

    // slotId -> popisek stolu (STŮL X)
    var labelBySlotId = new Dictionary<int, string>();

    // Id slotu, který je "v převozu" (jen jeden – první ve frontě)
    int? inTransitSlotId = null;

    // 1) namapujeme frontu na obsazené sloty (1. call -> spodní paleta, 2. call -> další, ...)
    for (int i = 0; i < occupiedSlots.Count && i < rowQueue.Count; i++)
    {
        var slot = occupiedSlots[i];
        var call = rowQueue[i];

        var tableName = call.WorkTable?.Name ?? $"Stůl {call.WorkTableId}";

        // zvýraznění aktuálního stolu (na stránce jednoho stolu)
        if (Model.CurrentTableId.HasValue && call.WorkTableId == Model.CurrentTableId.Value)
        {
            tableName = $"▶ {tableName}";
        }

        labelBySlotId[slot.Id] = tableName;
    }

    // 2) rozhodneme, jestli PRVNÍ call je zrovna "v převozu"
    if (rowQueue.Any() && occupiedSlots.Any())
    {
        var firstCall = rowQueue.First();
        // pokud od požadavku neuplynulo 10s, bereme to jako "v převozu"
        if (now - firstCall.RequestedAt < transitDuration)
        {
            // první call patří spodní paletě = prvnímu obsazenému slotu
            inTransitSlotId = occupiedSlots.First().Id;
        }
    }

    // 3) fronta, která se nevešla na palety (pro text "fronta: ...")
    var mappedCount = Math.Min(occupiedSlots.Count, rowQueue.Count);
    var remainingQueue = rowQueue.Skip(mappedCount).ToList();
}

<!-- Název řady -->
<div class="header-cell text-center fw-bold mb-2">
    @row.Name
</div>

<!-- Sloty -->
@for (int pos = maxCapacity - 1; pos >= 0; pos--)
{
    var slot = row.Slots.FirstOrDefault(s => s.PositionIndex == pos);

    var cls = "slot empty";
    string? label = null;

    if (slot != null && slot.State == PalletState.Occupied)
    {
        // defaultně obsazená
        cls = "slot occupied";

        // pokud je to konkrétní paleta, která je "v převozu", použijeme dashed styl
        if (inTransitSlotId.HasValue && slot.Id == inTransitSlotId.Value)
        {
            cls = "slot in-transit";
        }

        // popisek (název stolu), pokud je namapovaný
        labelBySlotId.TryGetValue(slot.Id, out label);
    }

    <div class="slot-wrapper mb-1">
        <div class="@cls" style="border-color:@row.ColorHex">
            @if (!string.IsNullOrEmpty(label))
            {
                <div class="slot-label">
                    @label
                </div>
            }
        </div>
    </div>
}

<!-- Název artiklu řady -->
<div class="article-label small text-muted text-center mt-1">
    @row.Article
</div>

<!-- Zbytek fronty -->
@if (remainingQueue.Any())
{
    <div class="queue-label small text-muted text-center mt-1">
        fronta:
        @string.Join(", ",
        remainingQueue.Select(c => c.WorkTable?.Name ?? $"Stůl {c.WorkTableId}"))
</div>
}
